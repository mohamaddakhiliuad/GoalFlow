<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="760">
  <style>
    .title { font: bold 18px sans-serif; }
    .label { font: 14px sans-serif; }
    .event { font: 13px sans-serif; }
    .lane { stroke: #999; stroke-dasharray: 6 4; fill: none; }
    .lifeline { stroke: #555; stroke-dasharray: 4 6; }
    .arrow { stroke: #222; stroke-width: 2; marker-end: url(#arrowhead); fill: none; }
    .box { fill: #fff; stroke: #333; stroke-width: 1.5; rx: 6; ry: 6; }
    .note { fill: #f9f9f9; stroke: #bbb; }
  </style>

  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#222"/>
    </marker>
  </defs>

  <!-- Header -->
  <text x="24" y="34" class="title">Runtime Sequence — CreateGoalCommand</text>
  <text x="24" y="58" class="label">Request → Validation → Handler → Repository/Transaction → Response</text>

  <!-- Swimlanes -->
  <g id="lanes">
    <!-- Client -->
    <text x="90" y="95" class="label">Client</text>
    <line x1="100" y1="110" x2="100" y2="720" class="lifeline" />
    <rect x="55" y="78" width="90" height="28" class="box"/>

    <!-- API -->
    <text x="320" y="95" class="label">API (Minimal API)</text>
    <line x1="340" y1="110" x2="340" y2="720" class="lifeline" />
    <rect x="265" y="78" width="150" height="28" class="box"/>

    <!-- MediatR/Validation -->
    <text x="560" y="95" class="label">MediatR + Validation</text>
    <line x1="580" y1="110" x2="580" y2="720" class="lifeline" />
    <rect x="500" y="78" width="160" height="28" class="box"/>

    <!-- Handler -->
    <text x="800" y="95" class="label">CreateGoalHandler</text>
    <line x1="820" y1="110" x2="820" y2="720" class="lifeline" />
    <rect x="742" y="78" width="156" height="28" class="box"/>

    <!-- Infrastructure -->
    <text x="1040" y="95" class="label">Repository / Tx</text>
    <line x1="1060" y1="110" x2="1060" y2="720" class="lifeline" />
    <rect x="988" y="78" width="144" height="28" class="box"/>
  </g>

  <!-- Messages -->
  <!-- 1. Client -> API -->
  <line x1="100" y1="140" x2="340" y2="140" class="arrow"/>
  <text x="110" y="132" class="event">POST /api/goals (CreateGoalBody)</text>

  <!-- 2. API maps to command and sends -->
  <line x1="340" y1="180" x2="580" y2="180" class="arrow"/>
  <text x="350" y="172" class="event">Send(CreateGoalCommand)</text>

  <!-- 3. Validation -->
  <rect x="540" y="200" width="82" height="24" class="note"/>
  <text x="548" y="217" class="event">FluentValidation</text>

  <!-- branch: invalid -->
  <line x1="580" y1="240" x2="340" y2="240" class="arrow"/>
  <text x="420" y="232" class="event">Result.Failure(validation_error)</text>
  <line x1="340" y1="280" x2="100" y2="280" class="arrow"/>
  <text x="150" y="272" class="event">400 ProblemDetails</text>

  <!-- 4. valid path to handler -->
  <line x1="580" y1="330" x2="820" y2="330" class="arrow"/>
  <text x="590" y="322" class="event">OK → Dispatch to Handler</text>

  <!-- 5. Handler constructs Domain entity -->
  <rect x="772" y="350" width="96" height="26" class="note"/>
  <text x="780" y="367" class="event">new Goal(...)</text>

  <!-- 6. Handler -> Repo -->
  <line x1="820" y1="400" x2="1060" y2="400" class="arrow"/>
  <text x="840" y="392" class="event">Repo.CreateAsync(goal)</text>

  <!-- 7. Repo -> Tx commit -->
  <rect x="1002" y="420" width="116" height="26" class="note"/>
  <text x="1010" y="437" class="event">Begin/Commit</text>

  <!-- 8. Repo -> Handler return id -->
  <line x1="1060" y1="470" x2="820" y2="470" class="arrow"/>
  <text x="900" y="462" class="event">goalId</text>

  <!-- 9. Handler -> API -->
  <line x1="820" y1="510" x2="340" y2="510" class="arrow"/>
  <text x="540" y="502" class="event">Result.Success(goalId)</text>

  <!-- 10. API -> Client -->
  <line x1="340" y1="550" x2="100" y2="550" class="arrow"/>
  <text x="160" y="542" class="event">201 Created { id }</text>

  <!-- Optional event side-effects -->
  <line x1="820" y1="600" x2="1060" y2="600" class="arrow" style="stroke-dasharray:5 5"/>
  <text x="830" y="592" class="event">Publish ProgressLogCreated / Notify</text>
</svg>
